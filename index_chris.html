<script>
    const inputCtx = document.getElementById('inputChart').getContext('2d');
    const outputCtx = document.getElementById('outputChart').getContext('2d');

    const inputChart = new Chart(inputCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [
                {
                    label: 'Input Voltage (V)',
                    data: [],
                    borderColor: '#1e90ff',
                    yAxisID: 'y',
                    fill: false,
                    tension: 0.3
                },
                {
                    label: 'Input Current (mA)',
                    data: [],
                    borderColor: '#ff6347',
                    yAxisID: 'y1',
                    fill: false,
                    tension: 0.3
                }
            ]
        },
        options: {
            plugins: {
                legend: { labels: { color: '#fff' } }
            },
            scales: {
                x: {
                    ticks: {
                        color: '#ccc',
                        callback: () => ''
                    },
                    title: {
                        display: true,
                        text: 'Time',
                        color: '#ccc'
                    }
                },
                y: {
                    type: 'linear',
                    position: 'left',
                    ticks: { color: '#ccc' },
                    title: { display: true, text: 'Voltage (V)', color: '#ccc' }
                },
                y1: {
                    type: 'linear',
                    position: 'right',
                    ticks: { color: '#ccc' },
                    grid: { drawOnChartArea: false },
                    title: { display: true, text: 'Current (mA)', color: '#ccc' }
                }
            }
        }
    });

    const outputChart = new Chart(outputCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [
                {
                    label: 'Output Voltage (V)',
                    data: [],
                    borderColor: '#00fa9a',
                    yAxisID: 'y',
                    fill: false,
                    tension: 0.3
                },
                {
                    label: 'Output Current (mA)',
                    data: [],
                    borderColor: '#ffa500',
                    yAxisID: 'y1',
                    fill: false,
                    tension: 0.3
                }
            ]
        },
        options: {
            plugins: {
                legend: { labels: { color: '#fff' } }
            },
            scales: {
                x: {
                    ticks: {
                        color: '#ccc',
                        callback: () => ''
                    },
                    title: {
                        display: true,
                        text: 'Time',
                        color: '#ccc'
                    }
                },
                y: {
                    type: 'linear',
                    position: 'left',
                    ticks: { color: '#ccc' },
                    title: { display: true, text: 'Voltage (V)', color: '#ccc' }
                },
                y1: {
                    type: 'linear',
                    position: 'right',
                    ticks: { color: '#ccc' },
                    grid: { drawOnChartArea: false },
                    title: { display: true, text: 'Current (mA)', color: '#ccc' }
                }
            }
        }
    });

    let autoUpdateInterval = null;

    async function fetchData() {
        try {
            const response = await fetch('data.json');
            const rawData = await response.json();

            const data = rawData.filter(e =>
                e.LowSideVoltage !== undefined &&
                e.HighSideVoltage !== undefined &&
                e.LowSideCurrent !== undefined &&
                e.HighSideCurrent !== undefined
            );

            const last = data[data.length - 1];
            const time = new Date(last.timestamp).toLocaleTimeString();
            const lowVoltage = parseFloat(last.LowSideVoltage) / 1000;
            const lowCurrent = parseFloat(last.LowSideCurrent);
            const highVoltage = parseFloat(last.HighSideVoltage) / 1000;
            const highCurrent = parseFloat(last.HighSideCurrent);
            const duty = last.DutyCycle;

            document.getElementById("duty-cycle").innerText = `Duty Cycle: ${duty}`;

            updateChart(inputChart, time, lowVoltage, lowCurrent);
            updateChart(outputChart, time, highVoltage, highCurrent);

        } catch (err) {
            console.error("Error fetching or parsing data:", err);
        }
    }

    function updateChart(chart, time, voltage, current) {
        const maxPoints = 120;

        chart.data.labels.push(time);
        chart.data.datasets[0].data.push(voltage);
        chart.data.datasets[1].data.push(current);

        if (chart.data.labels.length > maxPoints) {
            chart.data.labels.shift();
            chart.data.datasets[0].data.shift();
            chart.data.datasets[1].data.shift();
        }

        chart.update();
    }

    function refreshData() {
        fetchData();
        if (autoUpdateInterval) clearInterval(autoUpdateInterval);
        autoUpdateInterval = setInterval(fetchData, 500);
    }

    function clearGraphs() {
        if (autoUpdateInterval) clearInterval(autoUpdateInterval);

        inputChart.data.labels = [];
        inputChart.data.datasets.forEach(ds => ds.data = []);
        inputChart.update();

        outputChart.data.labels = [];
        outputChart.data.datasets.forEach(ds => ds.data = []);
        outputChart.update();

        document.getElementById("duty-cycle").innerText = "Duty Cycle: --%";
    }

    let chartsVisible = true;
    function toggleCharts() {
        chartsVisible = !chartsVisible;
        document.getElementById('inputChart').style.display = chartsVisible ? 'block' : 'none';
        document.getElementById('outputChart').style.display = chartsVisible ? 'block' : 'none';
    }

    // Start continuous updates on page load
    fetchData();
    autoUpdateInterval = setInterval(fetchData, 500);
</script>
