<script>
  const inputCtx = document.getElementById('inputChart').getContext('2d');
  const outputCtx = document.getElementById('outputChart').getContext('2d');

  const maxPoints = 120;

  const inputChart = new Chart(inputCtx, {
    type: 'line',
    data: {
      labels: [],
      datasets: [
        {
          label: 'Input Voltage (V)',
          data: [],
          borderColor: '#1e90ff',
          yAxisID: 'y',
          fill: false,
          tension: 0.3
        },
        {
          label: 'Input Current (mA)',
          data: [],
          borderColor: '#ff6347',
          yAxisID: 'y1',
          fill: false,
          tension: 0.3
        }
      ]
    },
    options: {
      plugins: {
        legend: { labels: { color: '#fff' } }
      },
      scales: {
        x: {
          ticks: { color: '#ccc' },
          title: { display: true, text: 'Time (mm:ss)', color: '#ccc' }
        },
        y: {
          type: 'linear',
          position: 'left',
          ticks: { color: '#ccc' },
          title: { display: true, text: 'Voltage (V)', color: '#ccc' }
        },
        y1: {
          type: 'linear',
          position: 'right',
          ticks: { color: '#ccc' },
          grid: { drawOnChartArea: false },
          title: { display: true, text: 'Current (mA)', color: '#ccc' }
        }
      }
    }
  });

  const outputChart = new Chart(outputCtx, {
    type: 'line',
    data: {
      labels: [],
      datasets: [
        {
          label: 'Output Voltage (V)',
          data: [],
          borderColor: '#00fa9a',
          yAxisID: 'y',
          fill: false,
          tension: 0.3
        },
        {
          label: 'Output Current (mA)',
          data: [],
          borderColor: '#ffa500',
          yAxisID: 'y1',
          fill: false,
          tension: 0.3
        }
      ]
    },
    options: {
      plugins: {
        legend: { labels: { color: '#fff' } }
      },
      scales: {
        x: {
          ticks: { color: '#ccc' },
          title: { display: true, text: 'Time (mm:ss)', color: '#ccc' }
        },
        y: {
          type: 'linear',
          position: 'left',
          ticks: { color: '#ccc' },
          title: { display: true, text: 'Voltage (V)', color: '#ccc' }
        },
        y1: {
          type: 'linear',
          position: 'right',
          ticks: { color: '#ccc' },
          grid: { drawOnChartArea: false },
          title: { display: true, text: 'Current (mA)', color: '#ccc' }
        }
      }
    }
  });

  function updateChart(chart, time, voltage, current) {
    chart.data.labels.push(time);
    chart.data.datasets[0].data.push(voltage);
    chart.data.datasets[1].data.push(current);

    if (chart.data.labels.length > maxPoints) {
      chart.data.labels.shift();
      chart.data.datasets[0].data.shift();
      chart.data.datasets[1].data.shift();
    }

    chart.update();
  }

  async function fetchData() {
    try {
      const response = await fetch('data.json');
      const rawData = await response.json();

      const latest = rawData[rawData.length - 1];
      const timestamp = new Date(latest.timestamp);
      const time = `${String(timestamp.getMinutes()).padStart(2, '0')}:${String(timestamp.getSeconds()).padStart(2, '0')}`;

      const lowVoltage = parseFloat(latest.LowSideVoltage); // already in V
      const lowCurrent = parseFloat(latest.LowSideCurrent);
      const highVoltage = parseFloat(latest.HighSideVoltage); // already in V
      const highCurrent = parseFloat(latest.HighSideCurrent);
      const duty = latest.DutyCycle;

      document.getElementById("duty-cycle").innerText = `Duty Cycle: ${duty}`;

      updateChart(inputChart, time, lowVoltage, lowCurrent);
      updateChart(outputChart, time, highVoltage, highCurrent);
    } catch (err) {
      console.error("Error fetching or parsing data:", err);
    }
  }

  function refreshData() {
    fetchData();
    if (window.autoUpdateInterval) clearInterval(window.autoUpdateInterval);
    window.autoUpdateInterval = setInterval(fetchData, 500);
  }

  function clearGraphs() {
    if (window.autoUpdateInterval) clearInterval(window.autoUpdateInterval);

    [inputChart, outputChart].forEach(chart => {
      chart.data.labels = [];
      chart.data.datasets.forEach(ds => ds.data = []);
      chart.update();
    });

    document.getElementById("duty-cycle").innerText = "Duty Cycle: --%";
  }

  function toggleCharts() {
    const inputCanvas = document.getElementById('inputChart');
    const outputCanvas = document.getElementById('outputChart');
    const visible = inputCanvas.style.display !== 'none';
    inputCanvas.style.display = visible ? 'none' : 'block';
    outputCanvas.style.display = visible ? 'none' : 'block';
  }

  // Start updating on page load
  refreshData();
</script>
